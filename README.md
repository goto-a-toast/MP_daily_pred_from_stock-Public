# MP予測モデル / MP Prediction Models

日次・月次のデータから限界利益（MP: Margin Profit）を予測する機械学習モデル集です。

## 📚 ノートブック一覧

### 1. 当月末MP予測モデル（日次データ版）

**ファイル**: `mp_current_month_prediction_model.ipynb`

[![Open In Colab](https://colab.research.google.com/assets/colab-badge.svg)](https://colab.research.google.com/github/goto-a-toast/MP_daily_pred_from_stock-Public/blob/claude/predict-monthly-mp-NcKkJ/mp_current_month_prediction_model.ipynb)

#### 概要
日次の確定値、A、B、C、Dの値から**当月末の限界利益**を予測するモデルです。

#### 特徴
- **入力**: 日次データ（確定MP、A、B、C、D、月、日）
- **出力**: 当月末のMP予測値
- **訓練データ**: 2,000日以上の日次データ
- **手法**: Random Forest + 月別・日別転換率のハイブリッド

#### 使用シーン
- 月の途中で月末のMPを予測したい場合
- 日次の進捗データを活用したリアルタイム予測
- 月内の各日における予測精度の推移を確認したい場合

#### 主な機能
- 日ごとの予測精度推移の可視化
- 月別・日別の転換率分析
- 月内予測の進捗シミュレーション
- 確定値と追加予測値の内訳表示

---

### 2. 翌月末MP予測モデル（日次の次月データ版）

**ファイル**: `mp_next_month_end_prediction_model.ipynb`

[![Open In Colab](https://colab.research.google.com/assets/colab-badge.svg)](https://colab.research.google.com/github/goto-a-toast/MP_daily_pred_from_stock-Public/blob/claude/predict-monthly-mp-NcKkJ/mp_next_month_end_prediction_model.ipynb)

#### 概要
日次の**次月データ**（次月確定、次月A、次月B、次月C、次月D）から**翌月末の限界利益**を予測するモデルです。

**例**: 4月の各日における「次月データ」（5月のために積み上げている値）から、5月末のMPを予測します。

#### 特徴
- **入力**: 日次の次月データ（次月確定MP、次月A、次月B、次月C、次月D、月、日）
- **出力**: 翌月末のMP予測値、翌月スタートMP（次月確定+次月A）
- **訓練データ**: 2,000日以上の日次データ
- **手法**: Random Forest + 月別・日別転換率のハイブリッド

#### 使用シーン
- **4月中に5月末のMPを予測**したい場合
- **翌月のスタートMP**（確定+A）がいくらになるか知りたい場合
- 次月のために日々積み上げているデータを活用したい場合
- 翌月の計画を早期に立てたい場合

#### 主な機能
- 当月の各日における翌月末予測の推移
- 翌月スタートMP（確定+A）の推移分析
- 予測対象月別の転換率分析
- 実績値との比較可視化

#### 重要ポイント
このモデルは、「当月のデータから当月末を予測」するのではなく、「当月のデータから**翌月末**を予測」します。

```
例：
4月15日時点のデータ:
├─ 次月確定MP: 500,000円    ┐
├─ 次月A: 45,000,000円      ├─ 5月スタートMP = 45,500,000円
├─ 次月B: 4,500,000円       │
├─ 次月C: 3,000,000円       ├─ 5月に追加で増える分を予測
└─ 次月D: 15,000,000円      ┘
  ↓
5月末MP: 約70,000,000円（予測）
```

---

### 3. 翌月MP予測モデル（月次データ版）

**ファイル**: `mp_monthly_prediction_model_v4 (1).ipynb`

[![Open In Colab](https://colab.research.google.com/assets/colab-badge.svg)](https://colab.research.google.com/github/goto-a-toast/MP_daily_pred_from_stock-Public/blob/main/mp_monthly_prediction_model_v4%20(1).ipynb)

#### 概要
月末時点のBMP、CMP、DMP、確定MP、AMPから**翌月の限界利益**を予測するモデルです。

#### 特徴
- **入力**: 月末データ（確定MP、AMP、BMP、CMP、DMP、月）
- **出力**: 翌月のMP予測値
- **訓練データ**: 69ヶ月分の月次データ
- **手法**: Random Forest + 月別転換率のハイブリッド

#### 使用シーン
- 月末時点で翌月のMPを予測したい場合
- 月次計画の策定
- 長期的なトレンド分析

#### 主な機能
- 月別転換率の分析
- 年間シミュレーション
- 実績値と予測値の比較可視化
- MAE、R²スコアによるモデル評価

---

## 🚀 使い方

### 1. Google Colabで開く
上記の「Open In Colab」バッジをクリックして、ブラウザ上でノートブックを開きます。

### 2. データをアップロード
ノートブックを実行すると、CSVファイルのアップロードを求められます。

### 3. 予測を実行
セルを順番に実行すると、自動的にモデルの訓練と予測が行われます。

---

## 📊 データフォーマット

### 必要なCSV形式

CSVファイルには**当月のデータ**と**次月のデータ**の両方が含まれます：

| 列名 | 説明 | 使用するモデル |
|------|------|---------------|
| 行ラベル | 日付（例：2020/4/1） | 全て |
| 合計 / MP | 当月MP | 当月末予測 |
| 合計 / 確定MP | 当月確定MP | 当月末予測 |
| 合計 / AMP | 当月A | 当月末予測 |
| 合計 / BMP | 当月B | 当月末予測 |
| 合計 / CMP | 当月C | 当月末予測 |
| 合計 / DMP | 当月D | 当月末予測 |
| 合計 / 次月MP | 次月MP | （参考用） |
| 合計 / 次月確定MP | 次月確定MP | 翌月予測 |
| 合計 / 次月AMP | 次月A | 翌月予測 |
| 合計 / 次月BMP | 次月B | 翌月予測 |
| 合計 / 次月CMP | 次月C | 翌月予測 |
| 合計 / 次月DMP | 次月D | 翌月予測 |

**サンプルデータ：**
```csv
行ラベル,合計 / MP,合計 / 確定MP,合計 / AMP,合計 / BMP,合計 / CMP,合計 / DMP,合計 / 次月MP,合計 / 次月確定MP,合計 / 次月AMP,合計 / 次月BMP,合計 / 次月CMP,合計 / 次月DMP
2020/4/1,52612321,3560426,49051895,9945801,6513693,24336375,0,0,15815626,1787889,2610055,58101088
```

**ポイント：**
- **当月末予測モデル**: 「次月」と書いていない列（2-6列目）を使用
- **翌月予測モデル**: 「次月」と書いている列（8-12列目）を使用
- **旧フォーマット（12列・7列）にも対応**: 自動検出により過去のデータも使用可能

### エンコーディング
- UTF-8-sig（推奨）
- Shift_JIS（自動検出対応）

---

## 🧠 モデルの仕組み

### 予測ロジック

両モデルとも、限界利益を**2つの部分**に分解して予測します：

#### 1. 確定部分（Confirmed）
```
Confirmed = 確定MP + AMP
```
ほぼ確実に獲得できる限界利益

#### 2. 追加部分（Additional）
```
Additional = Random Forest予測 × 0.7 + 転換率予測 × 0.3
```
B、C、Dから追加で獲得できると予測される限界利益

#### 最終予測
```
予測MP = Confirmed + Additional
```

### 転換率とは？

**転換率（Conversion Rate）** = B、C、Dの値が実際の追加利益にどれくらい変換されるかの割合

例：
- BCDの合計が10,000万円
- 実際の追加利益が7,000万円
- 転換率 = 70%

この転換率は月ごと、日ごとに異なるため、モデルは季節性やトレンドを学習します。

---

## 📈 モデル性能

### 当月末予測モデル
- **MAE**: 約200万円（10K JPY単位）
- **R² Score**: 0.96以上
- **訓練データ**: 2,000日以上の日次データ

### 翌月末予測モデル（次月データ版）
- **MAE**: 約200万円（10K JPY単位）
- **R² Score**: 0.96以上
- **訓練データ**: 2,000日以上の日次データ

### 翌月予測モデル（月次版）
- **MAE**: 約204万円（10K JPY単位）
- **R² Score**: 0.964
- **訓練データ**: 69ヶ月の月次データ

---

## 🔍 主な分析機能

### 当月末予測モデル
1. **月別・日別転換率分析**: 各月の各日における転換率の変化を可視化
2. **予測精度推移**: 月内の日ごとに予測精度がどう変化するか分析
3. **月内シミュレーション**: 特定の月の全日程での予測推移を表示
4. **過去の任意の月の推移分析**: 過去の月を選択して詳細に分析

### 翌月末予測モデル（次月データ版）
1. **当月の日ごとの翌月末予測推移**: 当月の進捗に応じて翌月末予測がどう変化するか
2. **翌月スタートMP推移**: 翌月の確定+Aがどう積み上がるか可視化
3. **予測対象月別転換率**: 翌月の季節性を考慮した転換率分析

### 翌月予測モデル（月次版）
1. **月別転換率**: 1月〜12月の転換率の季節性を分析
2. **年間シミュレーション**: 12ヶ月分の予測を一括表示
3. **実績vs予測グラフ**: 時系列での予測精度を可視化

---

## 💡 使い分けガイド

| 状況 | 推奨モデル |
|------|-----------|
| **月の途中で当月末**を予測したい | 当月末予測モデル |
| **月の途中で翌月末**を予測したい | 翌月末予測モデル（次月データ版）⭐NEW |
| **翌月のスタートMP**（確定+A）を知りたい | 翌月末予測モデル（次月データ版）⭐NEW |
| **月末時点で翌月**を予測したい | 翌月予測モデル（月次版） |
| 日次の進捗を反映したい | 当月末予測 or 翌月末予測（次月データ版） |
| 中長期的なトレンドを見たい | 翌月予測モデル（月次版） |
| より多くのデータで訓練したい | 当月末予測 or 翌月末予測（次月データ版） |

### 具体的な使い分け例

#### ケース1: 4月15日時点での予測

| 知りたいこと | 使うモデル | 使うデータ |
|-------------|----------|-----------|
| **4月末のMP** | 当月末予測モデル | 4月15日の当月データ（確定、A、B、C、D） |
| **5月末のMP** | 翌月末予測モデル | 4月15日の次月データ（次月確定、次月A、次月B、次月C、次月D） |
| **5月スタートMP** | 翌月末予測モデル | 4月15日の次月データ（次月確定 + 次月A） |

#### ケース2: 4月末時点での予測

| 知りたいこと | 使うモデル | 使うデータ |
|-------------|----------|-----------|
| **5月末のMP** | 翌月予測モデル（月次版） | 4月末の次月データ（月末まで完全）|

---

## 📝 カスタム予測の例

### 当月末予測モデル
```python
# 2月15日時点のデータから2月末を予測
prediction = predictor.predict(
    kakutei=609289,     # 確定MP
    a=47905097,         # A
    b=5236622,          # B
    c=3481478,          # C
    d=18589534,         # D
    month=2,            # 2月
    day=15              # 15日
)
```

### 翌月末予測モデル（次月データ版）⭐NEW
```python
# 4月15日時点の次月データから5月末を予測
prediction = predictor.predict(
    next_kakutei=500000,    # 次月確定MP
    next_a=45000000,        # 次月A
    next_b=4500000,         # 次月B
    next_c=3000000,         # 次月C
    next_d=15000000,        # 次月D
    current_month=4,        # 4月
    current_day=15          # 15日
)
# → 5月末MP予測、5月スタートMP（確定+A）が取得できる
```

### 翌月予測モデル（月次版）
```python
# 1月末時点のデータから2月を予測
prediction = predictor.predict(
    kakutei=609289,     # 確定MP
    amp=47905097,       # AMP
    bmp=5236622,        # BMP
    cmp=3481478,        # CMP
    dmp=18589534,       # DMP
    source_month=1      # 1月末
)
```

---

## 🛠️ 技術スタック

- **Python 3.8+**
- **pandas**: データ処理
- **numpy**: 数値計算
- **scikit-learn**: 機械学習（Random Forest）
- **matplotlib**: 可視化
- **seaborn**: 統計的可視化

---

## 📄 ライセンス

このプロジェクトはPublicリポジトリとして公開されています。

---

## 🤝 コントリビューション

改善提案やバグ報告は、GitHubのIssuesでお願いします。

---

## 📞 お問い合わせ

質問や要望がある場合は、GitHubのIssuesまでお願いします。

---

## 🔄 更新履歴

- **2026-02-10**: 当月末予測モデル（日次データ版）を追加
- **2026-02-03**: 翌月予測モデル（v4）を公開
