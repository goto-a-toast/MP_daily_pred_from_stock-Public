# MP予測モデル / MP Prediction Models

日次・月次のデータから限界利益（MP: Margin Profit）を予測する機械学習モデル集です。

## 📚 ノートブック一覧

### 1. 当月末MP予測モデル（日次データ版）

**ファイル**: `mp_current_month_prediction_model.ipynb`

[![Open In Colab](https://colab.research.google.com/assets/colab-badge.svg)](https://colab.research.google.com/github/goto-a-toast/MP_daily_pred_from_stock-Public/blob/claude/predict-monthly-mp-NcKkJ/mp_current_month_prediction_model.ipynb)

#### 概要
日次の確定値、A、B、C、Dの値から**当月末の限界利益**を予測するモデルです。

#### 特徴
- **入力**: 日次データ（確定MP、A、B、C、D、月、日）
- **出力**: 当月末のMP予測値
- **訓練データ**: 2,000日以上の日次データ
- **手法**: Random Forest + 月別・日別転換率のハイブリッド

#### 使用シーン
- 月の途中で月末のMPを予測したい場合
- 日次の進捗データを活用したリアルタイム予測
- 月内の各日における予測精度の推移を確認したい場合

#### 主な機能
- 日ごとの予測精度推移の可視化
- 月別・日別の転換率分析
- 月内予測の進捗シミュレーション
- 確定値と追加予測値の内訳表示

---

### 2. 翌月MP予測モデル（月次データ版）

**ファイル**: `mp_monthly_prediction_model_v4 (1).ipynb`

[![Open In Colab](https://colab.research.google.com/assets/colab-badge.svg)](https://colab.research.google.com/github/goto-a-toast/MP_daily_pred_from_stock-Public/blob/main/mp_monthly_prediction_model_v4%20(1).ipynb)

#### 概要
月末時点のBMP、CMP、DMP、確定MP、AMPから**翌月の限界利益**を予測するモデルです。

#### 特徴
- **入力**: 月末データ（確定MP、AMP、BMP、CMP、DMP、月）
- **出力**: 翌月のMP予測値
- **訓練データ**: 69ヶ月分の月次データ
- **手法**: Random Forest + 月別転換率のハイブリッド

#### 使用シーン
- 月末時点で翌月のMPを予測したい場合
- 月次計画の策定
- 長期的なトレンド分析

#### 主な機能
- 月別転換率の分析
- 年間シミュレーション
- 実績値と予測値の比較可視化
- MAE、R²スコアによるモデル評価

---

## 🚀 使い方

### 1. Google Colabで開く
上記の「Open In Colab」バッジをクリックして、ブラウザ上でノートブックを開きます。

### 2. データをアップロード
ノートブックを実行すると、CSVファイルのアップロードを求められます。

### 3. 予測を実行
セルを順番に実行すると、自動的にモデルの訓練と予測が行われます。

---

## 📊 データフォーマット

### 必要なCSV形式

CSVファイルには**当月のデータ**と**次月のデータ**の両方が含まれます：

| 列名 | 説明 | 使用するモデル |
|------|------|---------------|
| 行ラベル | 日付（例：2020/4/1） | 両方 |
| 合計 / MP | 当月MP | 当月末予測 |
| 合計 / 確定MP | 当月確定MP | 当月末予測 |
| 合計 / AMP | 当月A | 当月末予測 |
| 合計 / BMP | 当月B | 当月末予測 |
| 合計 / CMP | 当月C | 当月末予測 |
| 合計 / DMP | 当月D | 当月末予測 |
| 合計 / 次月確定MP | 次月確定MP | 翌月予測 |
| 合計 / 次月AMP | 次月A | 翌月予測 |
| 合計 / 次月BMP | 次月B | 翌月予測 |
| 合計 / 次月CMP | 次月C | 翌月予測 |
| 合計 / 次月DMP | 次月D | 翌月予測 |

**サンプルデータ：**
```csv
行ラベル,合計 / MP,合計 / 確定MP,合計 / AMP,合計 / BMP,合計 / CMP,合計 / DMP,合計 / 次月確定MP,合計 / 次月AMP,合計 / 次月BMP,合計 / 次月CMP,合計 / 次月DMP
2020/4/1,52612321,3560426,49051895,9945801,6513693,24336375,0,15815626,1787889,2610055,58101088
```

**ポイント：**
- **当月末予測モデル**: 「次月」と書いていない列（1-6列目）を使用
- **翌月予測モデル**: 「次月」と書いている列（7-11列目）を使用

### エンコーディング
- UTF-8-sig（推奨）
- Shift_JIS（自動検出対応）

---

## 🧠 モデルの仕組み

### 予測ロジック

両モデルとも、限界利益を**2つの部分**に分解して予測します：

#### 1. 確定部分（Confirmed）
```
Confirmed = 確定MP + AMP
```
ほぼ確実に獲得できる限界利益

#### 2. 追加部分（Additional）
```
Additional = Random Forest予測 × 0.7 + 転換率予測 × 0.3
```
B、C、Dから追加で獲得できると予測される限界利益

#### 最終予測
```
予測MP = Confirmed + Additional
```

### 転換率とは？

**転換率（Conversion Rate）** = B、C、Dの値が実際の追加利益にどれくらい変換されるかの割合

例：
- BCDの合計が10,000万円
- 実際の追加利益が7,000万円
- 転換率 = 70%

この転換率は月ごと、日ごとに異なるため、モデルは季節性やトレンドを学習します。

---

## 📈 モデル性能

### 当月末予測モデル
- **MAE**: 約200万円（10K JPY単位）
- **R² Score**: 0.96以上
- **訓練データ**: 2,000日以上の日次データ

### 翌月予測モデル
- **MAE**: 約204万円（10K JPY単位）
- **R² Score**: 0.964
- **訓練データ**: 69ヶ月の月次データ

---

## 🔍 主な分析機能

### 当月末予測モデル
1. **月別・日別転換率分析**: 各月の各日における転換率の変化を可視化
2. **予測精度推移**: 月内の日ごとに予測精度がどう変化するか分析
3. **月内シミュレーション**: 特定の月の全日程での予測推移を表示

### 翌月予測モデル
1. **月別転換率**: 1月〜12月の転換率の季節性を分析
2. **年間シミュレーション**: 12ヶ月分の予測を一括表示
3. **実績vs予測グラフ**: 時系列での予測精度を可視化

---

## 💡 使い分けガイド

| 状況 | 推奨モデル |
|------|-----------|
| 月の途中で月末を予測したい | 当月末予測モデル |
| 月末時点で翌月を予測したい | 翌月予測モデル |
| 日次の進捗を反映したい | 当月末予測モデル |
| 中長期的なトレンドを見たい | 翌月予測モデル |
| より多くのデータで訓練したい | 当月末予測モデル |

---

## 📝 カスタム予測の例

### 当月末予測モデル
```python
# 2月15日時点のデータから2月末を予測
prediction = predictor.predict(
    kakutei=609289,     # 確定MP
    a=47905097,         # A
    b=5236622,          # B
    c=3481478,          # C
    d=18589534,         # D
    month=2,            # 2月
    day=15              # 15日
)
```

### 翌月予測モデル
```python
# 1月末時点のデータから2月を予測
prediction = predictor.predict(
    kakutei=609289,     # 確定MP
    amp=47905097,       # AMP
    bmp=5236622,        # BMP
    cmp=3481478,        # CMP
    dmp=18589534,       # DMP
    source_month=1      # 1月末
)
```

---

## 🛠️ 技術スタック

- **Python 3.8+**
- **pandas**: データ処理
- **numpy**: 数値計算
- **scikit-learn**: 機械学習（Random Forest）
- **matplotlib**: 可視化
- **seaborn**: 統計的可視化

---

## 📄 ライセンス

このプロジェクトはPublicリポジトリとして公開されています。

---

## 🤝 コントリビューション

改善提案やバグ報告は、GitHubのIssuesでお願いします。

---

## 📞 お問い合わせ

質問や要望がある場合は、GitHubのIssuesまでお願いします。

---

## 🔄 更新履歴

- **2026-02-10**: 当月末予測モデル（日次データ版）を追加
- **2026-02-03**: 翌月予測モデル（v4）を公開
